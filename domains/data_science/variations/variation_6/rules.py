RULES = [
    "Merge Window Protocol (MWP): When provided with (city, station_id, analysis window [start_ts, end_ts], water-level lookback [lookback_start, analysis_start]), the assistant shall: (1) retrieve weather forecasts for the specified city that span the analysis window from weather_forecasts; (2) fetch tide predictions for the given station_id covering the analysis window from tide_predictions; (3) collect observed water levels for the station_id over the lookback window from water_levels; (4) generate a single ETL run entry in etl_runs that authoritatively summarizes these input sources along with one merged output artifact.",
    "MWP canonical derivations (deterministic): city_slug is defined as the canonical slug for the city (refer to mapping in tools); run_id is constructed as f\"etl_{city_slug}_{start_ts[:10].replace('-','')}_{end_ts[:10].replace('-','')}_merge_v1\"; input_paths are set to [f\"/data/raw/weather_{city_slug}_{start_ts[:10].replace('-','')}.json\", f\"/data/raw/tide_pred_{station_id}.json\", f\"/data/raw/water_levels_{station_id}.json\"]; output_paths are [f\"/processed_data/merged_timeseries_{city_slug}_{start_ts[:10].replace('-','')}_{end_ts[:10].replace('-','')}.csv\"]; started_ts='2024-03-16T14:00:00Z', finished_ts_nullable='2024-03-16T14:22:00Z'. Instructions may override started_ts, finished_ts_nullable, messages, and required outputs if specified in the task instruction. messages := [f\"Merged weather and tide predictions for {start_ts[:10]}..{end_ts[:10]}.\", f\"Attached observed water levels lookback {lookback_start[:10]}..{analysis_start[:10]}.\", \"Output columns: timestamp, precipitation_mm_hr, temperature_2m_c, wind_speed_10m_ms, tide_pred_m, water_level_m, pressure_hpa.\"]. The ETL record must contain only: run_id, input_paths, output_paths, started_ts, finished_ts_nullable, messages. No additional fields are permitted.",
    "Split Protocol (SP): When given (city, method, test_fraction, split_ts), the assistant is required to: (1) determine the canonical processed timeseries path as /data/processed/timeseries_{city_slug}_weather.csv; (2) obtain the total row_count from processed_timeseries; (3) calculate train_index_count as floor(row_count * (1 - test_fraction)) and test_index_count as row_count minus train_index_count; (4) set split_summary_json_path to f\"/data/splits/{city_slug}_{method}_split_{split_ts[:10].replace('-', '')}.json\"; (5) insert a record into dataset_split containing exactly: {method, test_fraction, train_index_count, test_index_count, split_summary_json_path, split_ts}. The assistant must not include any fields beyond these.",
    "Feature Validation Protocol (FVP): For a given (city, model_name), the assistant shall: (1) determine the canonical city_slug; (2) retrieve the model's required feature_names from models; (3) obtain available feature columns and created_ts from /processed_data/features.csv; (4) identify present and missing feature sets, calculate their counts, and determine coverage as present/required; (5) generate a single ETL run entry in etl_runs that records the input parameters and one output artifact.",
    "FVP canonical derivations:",
    "city_slug := the canonical slug assigned to the city.",
    "Set features_csv_path to '/processed_data/features.csv'.",
    "Assign to ymd the value of created_ts sliced up to the first 10 characters, with all '-' characters removed.",
    "Define run_id as f'fv_{city_slug}_{model_name}_{ymd}_v1'.",
    "feature_validation_json_path is defined as f'/processed_data/feature_validation_{city_slug}_{model_name}_{ymd}.json'.",
    "started_ts is set to '2024-03-17T10:20:00Z', and finished_ts_nullable is set to '2024-03-17T10:25:00Z'. These values, along with messages and required outputs, may be replaced by those specified in the task instruction.",
    "messages consists of three strings: (a) indicating present/required counts, (b) listing sorted missing feature names or 'none', and (c) providing the validated file path.",
    "The ETL record must contain exclusively the following fields: run_id, input_paths, output_paths, started_ts, finished_ts_nullable, and messages. No additional fields are permitted.",
    "FVP messages are required to be exactly three strings: (1) 'Feature validation for {model_name}: {present_count}/{required_count} required features present.' (2) 'Missing features: ' followed by the missing feature names, sorted in lexicographical order and separated by ', ', or 'none' if there are no missing features. (3) 'Validated file: {feature_validation_json_path}'.",
    "Model Training & Evaluation Protocol (MTP): When provided with (city, station_id, model_name, analysis window [start_ts,end_ts], split_ts), the assistant shall: (1) determine the canonical city_slug; (2) generate a single ETL run record in etl_runs that summarizes the inputs and outputs for a deterministic training or evaluation; (3) return the stored model metrics without performing any new computation.",
    "MTP canonical derivations:",
    "city_slug refers to the canonical slug assigned to the city.",
    "run_id is defined as f\"mt_{city_slug}_{model_name}_{start_ts[:10].replace('-','')}_{end_ts[:10].replace('-','')}_v1\";",
    "input_paths := [f\"/processed_data/merged_timeseries_{city_slug}_{start_ts[:10].replace('-','')}_{end_ts[:10].replace('-','')}.csv\", \"/processed_data/features.csv\", f\"/data/splits/{city_slug}_time_based_split_{split_ts[:10].replace('-', '')}.json\"];",
    "output_paths := [f\"/models/{model_name}.pkl\", f\"/processed_data/metrics_summary_{model_name}_{end_ts[:10].replace('-','')}.csv\"];",
    "started_ts='2024-03-17T09:30:00Z', finished_ts_nullable='2024-03-17T11:15:00Z'. When specified in the task instruction, the instructions are permitted to update started_ts, finished_ts_nullable, messages, and required outputs.",
    "messages := [\"Training samples: 134\", \"Test samples: 34\", f\"Model saved to: /models/{model_name}.pkl\"];",
    "The ETL record should contain exclusively the following fields: run_id, input_paths, output_paths, started_ts, finished_ts_nullable, and messages. No additional fields are permitted.",
    "MTP messages are required to consist of exactly three strings: 'Training samples: {train}', 'Test samples: {test}', and 'Model saved to: {model_path}'.",
]
